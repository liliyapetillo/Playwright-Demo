name: Playwright Tests
# E2E Smoke Tests are required for PR merge, Other Tests are optional

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  e2e-smoke:
    name: E2E Smoke Tests
    timeout-minutes: 30
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Build Docker test image
      run: docker build -t playwright-test-image .
    
    - name: Run E2E smoke tests in Docker
      uses: nick-fields/retry@v3
      with:
        max_attempts: 2
        retry_wait_seconds: 20
        timeout_minutes: 10
        command: |
          docker run --rm \
            -v ${{ github.workspace }}/allure-results:/tests/allure-results \
            -e CI=true \
            -e BROWSER=${{ matrix.browser }} \
            playwright-test-image npx playwright test tests/e2e-smoke.spec.ts --project=${{ matrix.browser }}
    
    - name: Upload Allure results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: allure-results-smoke-${{ matrix.browser }}
        path: allure-results/
        retention-days: 30

  other-tests:
    name: Other Tests (excluding E2E Smoke)
    timeout-minutes: 60
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Build Docker test image
      run: docker build -t playwright-test-image .
    
    - name: Run other tests in Docker (auto-retry on failure)
      uses: nick-fields/retry@v3
      with:
        max_attempts: 2
        retry_wait_seconds: 20
        timeout_minutes: 10
        command: |
          docker run --rm \
            -v ${{ github.workspace }}/allure-results:/tests/allure-results \
            -e CI=true \
            -e BROWSER=${{ matrix.browser }} \
            playwright-test-image npx playwright test tests/auth.spec.ts tests/contacts.spec.ts tests/api.spec.ts tests/a11y.spec.ts tests/logout.spec.ts --project=${{ matrix.browser }}
    
    - name: Upload Allure results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: allure-results-other-${{ matrix.browser }}
        path: allure-results/
        retention-days: 30

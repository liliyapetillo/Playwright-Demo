name: Deploy Allure Report

on:
  workflow_run:
    workflows: ["Playwright Tests"]
    types: [completed]
  workflow_dispatch:
    inputs:
      resetHistory:
        description: "Reset Allure history (do not merge previous runs)"
        required: false
        default: "false"

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'
    environment:
      name: github-pages
      url: ${{ steps.deploy.outputs.page_url }}

    steps:
    - name: Download artifacts from workflow_run event
      if: github.event_name == 'workflow_run'
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        pattern: allure-results-*
        merge-multiple: true
        github-token: ${{ github.token }}
        run-id: ${{ github.event.workflow_run.id }}

    - name: Download artifacts from latest test run (manual trigger)
      if: github.event_name == 'workflow_dispatch'
      uses: dawidd6/action-download-artifact@v3
      with:
        workflow: playwright.yml
        workflow_conclusion: success
        name_is_regexp: true
        name: allure-results-.*
        path: artifacts

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install allure-commandline
      run: npm install -g allure-commandline

    - name: Merge Allure results from all browsers
      run: |
        mkdir -p merged-results
        if [ -d "artifacts" ]; then
          echo "Flattening Allure files (results, containers, attachments, metadata)"
          echo "Copying result JSON files..."
          find artifacts -type f -name '*-result.json' -exec cp {} merged-results/ \;
          echo "Copying container JSON files..."
          find artifacts -type f -name '*-container.json' -exec cp {} merged-results/ \;
          echo "Copying attachments..."
          find artifacts -type f -name '*-attachment.*' -exec cp {} merged-results/ \;
          echo "Copying metadata (environment, categories)..."
          find artifacts -type f \( -name 'environment.properties' -o -name 'categories.json' \) -exec cp {} merged-results/ \;
        else
          echo "ERROR: artifacts directory does not exist!"
          exit 1
        fi
        echo "Merged results file count: $(ls -1 merged-results/ | wc -l)"
        echo "Result JSON count: $(find merged-results -name '*-result.json' -type f | wc -l)"
        echo "Container JSON count: $(find merged-results -name '*-container.json' -type f | wc -l)"
        echo "Sample of merged-results:"
        ls -la merged-results/ | head -30

    - name: Checkout repository for scripts
      uses: actions/checkout@v4
      with:
        sparse-checkout: |
          scripts/filter-skipped.js
          scripts/allure-categories.js
        sparse-checkout-cone-mode: false

    - name: Filter skipped tests from Allure results
      run: |
        if [ -f scripts/filter-skipped.js ]; then
          node scripts/filter-skipped.js merged-results
        else
          echo "Warning: filter-skipped.js not found, skipping filter step"
        fi

    - name: Add Allure categories
      run: |
        node scripts/allure-categories.js merged-results

    - name: Download previous Allure history artifact
      if: github.event_name != 'workflow_dispatch' || github.event.inputs.resetHistory != 'true'
      uses: dawidd6/action-download-artifact@v3
      with:
        workflow: deploy-allure.yml
        branch: main
        workflow_conclusion: success
        name: allure-history
        path: previous-history
      continue-on-error: true

    - name: Merge history into results
      if: github.event_name != 'workflow_dispatch' || github.event.inputs.resetHistory != 'true'
      run: |
        if [ -d "previous-history" ] && [ "$(ls -A previous-history)" ]; then
          echo "Merging history..."
          mkdir -p merged-results/history
          cp -r previous-history/* merged-results/history/ 2>/dev/null || true
          echo "History merged successfully"
        else
          echo "No previous history to merge"
        fi
        echo "=== Final merged-results/history contents ==="
        ls -la merged-results/history/ 2>/dev/null || echo "No history directory in merged-results"

    - name: Generate Allure Report
      run: allure generate merged-results -o allure-report

    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./allure-report

    - name: Deploy to GitHub Pages
      id: deploy
      uses: actions/deploy-pages@v4

    - name: Upload Allure history artifact for next run
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: allure-history
        path: allure-report/history
        retention-days: 30
